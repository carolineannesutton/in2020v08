---
title: "IN2020V08"
author: "Caroline Sutton"
date: "17/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(tidyverse)
library(dplyr)
library(knitr)
library(geosphere)

# read in data
ccomp <- read_csv("data/in2020_v08_samples1.csv")
length <- read_csv("data/IN2020_V08_Lengths_Tidy.csv")
Shot <- read_csv("data/IN2020_V08_ShotData.csv")
deployments <- read_csv("data/in2020_v08_deployments.csv")

```

```{r Length Data}

# change to uniform names for 'deployment' and 'Accession number' and match species names in length data
ccomp_1 <- ccomp %>% 
  rename(Deployment = 'Operation No', Acc = 'Accession No') %>% 
  select(Voyage, Deployment,Acc,Taxa,CAAB, weight_g =`Weight (g)`, Count) %>% 
   mutate(ACat = ifelse(CAAB == 99110232, "Gelatinous",
                        ifelse(CAAB ==99270010, "Crustacean",
                        ifelse(CAAB == 99901011, "Gelatinous",
                        ifelse(CAAB >= 37000000,"Fish",
                        ifelse(CAAB == 36010000, "Chaetognath",
                               ifelse(CAAB >= 35000000, "Gelatinous",
                                      ifelse(CAAB >= 27000000, "Crustacean",
                                             ifelse(CAAB >= 23000000, "mollusc",
                                                    ifelse(CAAB >=11000000, "Gelatinous",
                                                           
                          "other"))))))))))

species_list <- ccomp_1 %>% 
  distinct(Taxa,.keep_all = TRUE)

fvgtr rghyt6u7jm87hblength_1 <- length %>% 
  rename(Acc = 'Acc #') %>% 
  left_join(ccomp_1, by = c("Deployment", "Acc"))
  


```
Catch Comp summary
```{r catch summary}
ccomp_2 <- ccomp_1 %>% 
  dplyr::group_by(Deployment,ACat) %>% 
  dplyr::summarise(nos= sum(Count, na.rm = TRUE),weight = sum(weight_g, na.rm = TRUE))
```

RMT 16 net area = 16m^2
speed of vessel on average  = 1kt *** but check with Grafana
time of tow = mins
conversion of kts to kph = kts * 1.852 (kph)
conversion of kph to mpm= kph * 16.667 (mpm)
volume filtered (m^3)= distance (m)* net mouth area (m^2) = ((speed (m/min) * time towed (min)) * net area (m^2))
```{r volume filtered calculation}
Shot_1 <- Shot %>% 
  filter(Category== "Start" | Category == "Stop") %>% 
   select(-Date,-Depth,-'Sea Water Temperature', -Author, - 'Op owner', date = 'Real Date')%>%
  
  #change Latitude to Decimal degrees
  mutate(Lat = Latitude) %>% 
  separate(Lat, c("deg","min","dir"),sep = " ") %>% 
  mutate(deg = as.numeric(deg)) %>% 
  mutate(dir = as.numeric(dir)) %>% 
  mutate(lat_decdeg = -deg + dir/60) %>% 
  #mutate(Date1 = date) %>% 
  #separate(date, c("Date","Time"), sep = " ") %>% 
  mutate(DateR = date) %>% 
  mutate(date = as.POSIXct(date, format = "%d/%m/%Y %H:%M")) %>% 
  
#change longitude to decimal degrees
mutate(Long = Longitude) %>% 
  separate(Long, c("ldeg","lmin","ldir"),sep = " ") %>% 
  mutate(ldeg = as.numeric(ldeg)) %>% 
  mutate(ldir = as.numeric(ldir)) %>% 
  mutate(long_decdeg = -ldeg + ldir/60) %>% 
  select(-deg,-min,-dir,-ldeg,-lmin,-ldir)
 

# Spitting the data into two tables one for start and one for stop
start <- Shot_1 %>% 
  filter(Category == "Start")
stop <- Shot_1 %>% 
  filter(Category =="Stop") %>% 
  select('Op number', lat_decdeg,long_decdeg,Location,date,DateR) 

# combining data to have start and stop data for time and position in one row. To calculate distance and time differences
Shot_2 <- start %>%
  left_join(stop, by = 'Op number', suffix= c("_start", "_stop")) %>%
  select(-Category, Site=Location_start, Net_Name = Type, Depth_Stratum = Subject,
         Deployment = 'Op number') %>% 
  separate(Depth_Stratum,c("Depth_Stratum","daylight"),sep = " ") %>% 
  mutate(towtime = difftime(date_stop,date_start, units = "mins")) %>% 
  mutate(Speed_mpm = 1*1.852*16.667) %>% 
  mutate(distance_m = Speed_mpm * towtime) %>%
  mutate(distance_m=as.numeric(distance_m)) %>% 
  mutate(VolumeFiltered_m3 = distance_m * 16) %>% 
  mutate(towtime = difftime(date_stop,date_start, units = "mins")) 
 
  
tally <- Shot_2 %>% 
  filter(Depth_Stratum == "Epi" | Depth_Stratum =="Lmeso" | Depth_Stratum == "Meso") %>% 
  group_by(daylight, Depth_Stratum) %>% 
  summarise(n())
  
  #CR_Date$hours <- with(CR_Date, difftime(pos2,pos1,units="hours") )
#CR_Date
  
```


joining shot and catch data
```{r}
deployments_1 <- deployments %>% 
  select(Operation, `Total Weight (g)`, Sweight_g =`Total Sorted Weight (g)`)


Sol_Micro <-left_join(Shot_2,deployments_1, by= c("Deployment" = "Operation")) %>% 
  mutate(StdW_gm3 = Sweight_g / VolumeFiltered_m3) %>% 
  mutate(Stdw_g1000m3 = StdW_gm3*1000) %>%
  select(-'Message ID', -Latitude,-Longitude, -Location_stop, -date_stop) %>%   filter(Depth_Stratum == "Epi" | Depth_Stratum =="Lmeso" | Depth_Stratum == "Meso") 
  #group_by(daylight, Depth_Stratum) %>% 
  #summarise(n())

#summary
Sol_Micro_summary <- Sol_Micro %>% 
  group_by(daylight,Depth_Stratum) %>% 
  summarise(n(), mean_g1000m3 = mean(Stdw_g1000m3), sd = sd(Stdw_g1000m3))
  
```
Plotting total catch
```{r}
# all deployments by day, depth
ggplot(Sol_Micro,
       mapping = aes(x = (Deployment), 
                     y = Stdw_g1000m3))+
geom_col(aes(fill=daylight) )+
facet_grid(~Depth_Stratum)

#deployments by depth and day
ggplot(Sol_Micro_summary,
       mapping = aes(x = as.factor(Depth_Stratum), 
                     y = mean_g1000m3))+
  geom_errorbar(aes(ymin = mean_g1000m3 - sd, ymax= mean_g1000m3 + sd)) +
geom_col()+
  facet_grid(~daylight)
                
  
```
Figures
```{r}

Day_Depth <- Sol_Micro %>% 
  #filter(Depth_Stratum == "Epi" | Depth_Stratum =="Lmeso" | Depth_Stratum == "Meso") 
  group_by(daylight,Depth_Stratum) %>% 
  summarise(n(), WSorted_g = mean(Sweight,na.rm = TRUE),sd= sd(Sweight, na.rm = TRUE))
```

                                   
                                  
 

  #calculate distance from position

write.csv(Shot_2,"Results/shotdata.csv")
 
`


    


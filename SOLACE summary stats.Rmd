---
title: "Summary data"
author: "sutton"
date: "24/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# library(plyr)
# library(Rmisc)
# library(lattice)
# library(tidyr)
library(tidyverse)
# library(gridExtra)
library(dplyr)
library(knitr)
library(ggpubr) # nice plots
library(rstatix) # pip freindly stats
# library(geosphere)
# library(janitor)


SOLACE <- read_csv("Results/IN2020_V08_CatchComp.csv")

SOLACE_nogel <- SOLACE %>% 
  #distinct(Acoustic_Category)
  filter(Acoustic_Category != "G_nGB")
```


```{r cummulative biomass}


distinct(SOLACE,Depth_Stratum)

SOLACE_cumsum <- SOLACE %>% 
  select(Site,Acoustic_Category,Taxa_updated,weight_g) %>% 
  group_by(Site,Taxa_updated) %>% 
  summarise(weight = sum(weight_g)) %>% 

 # ungroup() %>% 
  arrange(Site,-weight) %>% 
  mutate(cumsum = cumsum(weight)) %>% 
  mutate(percent =round(weight/sum(weight),2)) %>%
  mutate(cumpercent = round(cumsum/sum(weight),2))  

```


```{r sum biomass by deployment}
Biomass_deployment <- SOLACE %>% 
  select(Site, daylight,Depth_Stratum, Deployment, Taxa_updated,Acoustic_Category, Abd_Std_nosm3_sp,Weight_Std_gm3_sp) %>%
  dplyr::group_by(Site, daylight, Depth_Stratum,Deployment) %>% 
  dplyr::summarise(Weight = round(sum(Weight_Std_gm3_sp*1000),2), 
                   abd = round(sum(Abd_Std_nosm3_sp*1000),2)) %>% 
  dplyr::ungroup() %>% 
  mutate(logwt = log(Weight))
    

Biomass_deployment_design <- Biomass_deployment %>% 
  group_by(Site,daylight,Depth_Stratum) %>% 
  summarise(Weight = mean(Weight), 
            sd = sd(Weight),n())
  
SOLACE %>% 
  distinct(Acoustic_Category)
```

```{r summary stats}
Biomass_deployment$Depth_Stratum <- factor(as.factor(Biomass_deployment$Depth_Stratum), levels=c("Lmeso","Meso","Epi"))
Biomass_deployment$Site <- factor(as.factor(Biomass_deployment$Site), levels=c("SOTS","55S","58S"))
Biomass_deployment$daylight <- factor(as.factor(Biomass_deployment$daylight), levels=c("Day","Night"))

Biomass_design <-Biomass_deployment %>% 
  mutate(logwt = log(Weight)) %>% 
  group_by(Site, daylight, Depth_Stratum) %>% 
  get_summary_stats(Weight, type = "mean_sd")
```
boxplot
```{r boxplot}
bxp <- ggboxplot(
  Biomass_deployment, x = "daylight", y = "logwt", 
  color = "Depth_Stratum", palette = "jco", facet.by = "Site"
  )
bxp
```

barplot weight
```{r barplot weight}
Biomass_design_daylight <- Biomass_design %>% 
  mutate(mean = ifelse(daylight %in% "Night", mean*-1, mean)) 


barp <-ggplot(Biomass_design_daylight,
       mapping = aes(x = as.factor(Depth_Stratum),
                     y = mean, fill = daylight))+
  scale_fill_brewer()+
  geom_errorbar(aes(ymin = mean - sd, ymax= mean + sd),
                width = 0.4, position = position_dodge(0)) +
geom_col()+
  coord_flip()+
  facet_grid(~Site)+
  theme_bw()
barp

```


barplot logwt
```{r barplot weight}
barp <-ggplot(Biomass_design,
       mapping = aes(x = as.factor(Depth_Stratum),
                     y = mean, fill = daylight))+
  scale_fill_brewer()+
  geom_errorbar(aes(ymin = mean - sd, ymax= mean + sd),
                width = 0.4, position = position_dodge(0)) +
geom_col()+
  coord_flip()+
  facet_grid(~Site)+
  theme_bw()
barp

```

outliers
```{r outliers}
Biomass_deployment %>%
  group_by(Site,Depth_Stratum) %>%
  identify_outliers(logwt)
# dont get this
# deployments 8 and 13 are outliers but not extreme. Outliers are not obvious when using Site alone, all 3 factors or Site&daylight
```


normality

In the QQ plot, as all the points fall approximately along the reference line, we can assume normality. 

This conclusion is supported by the Shapiro-Wilk test, if the p-value is not significant. 
then  can assume normality.
```{r normality}
model  <- lm(logwt ~ Site*daylight*Depth_Stratum, data = Biomass_deployment)
# Create a QQ plot of residuals
ggqqplot(residuals(model))
# Compute Shapiro-Wilk test of normality
shapiro_test(residuals(model))

# probs not quite normally distributed - should transform

```
normality by groups
```{r shapiro test by groups}
Biomass_deployment %>%
  group_by(Site, daylight, Depth_Stratum) %>%
  shapiro_test(Weight)
```



QQ test
```{r qqtest}
ggqqplot(BulkBiomass, "Weight", ggtheme = theme_bw()) +
  facet_grid(Site + daylight ~ Depth_Stratum, labeller = "label_both")
```

homgeneity
```{r levenes}
BulkBiomass %>% levene_test(Weight ~ Site*daylight*Depth_Stratum)
# not significant assume homogeneity
```

Anova
```{r anova}
bio.aov <-  BulkBiomass%>% anova_test(Weight ~ Depth_Stratum*daylight*Site)
bio.aov
# there was a 3way interaction F(2,22)= 3.04, p = 0.039
```
Post hoc tests
2 way interactions
decide which two variables will form the simple two-way interactions and which variable will act as the third (moderator) variable. 

```{r post hoc 2 way interaction}
# Group the data by gender and 
# fit simple two-way interaction 
model  <- lm(Weight ~ daylight*Site*Depth_Stratum, data = Biomass_deployment)
Biomass_deployment %>%
  group_by(daylight) %>%
  anova_test(Weight ~ Depth_Stratum*Site, error = model)
```